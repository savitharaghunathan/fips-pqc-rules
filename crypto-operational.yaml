- ruleID: fips-go-ops-00100
  labels:
    - "konveyor.io/target=go"
  effort: 4
  category: mandatory
  description: "Unacceptable: Hardcoded cryptographic key detected"
  when:
    or:
      - builtin.filecontent:
          pattern: 'aes\.NewCipher\s*\(\s*\[\]byte\s*\(\s*"[^"]+"\s*\)\s*\)'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'des\.NewCipher\s*\(\s*\[\]byte\s*\(\s*"[^"]+"\s*\)\s*\)'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'rc4\.NewCipher\s*\(\s*\[\]byte\s*\(\s*"[^"]+"\s*\)\s*\)'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'hmac\.New\s*\([^,]+,\s*\[\]byte\s*\(\s*"[^"]+"\s*\)\s*\)'
          filePattern: "*.go"
  message: |
    Critical Security Vulnerability. Hardcoded cryptographic key detected in source code.

    Hardcoded keys are:
    - Exposed in version control history
    - Visible to anyone with code access
    - Impossible to rotate without code changes
    - Violate key management best practices

    Action: Load keys from secure sources:
    - Environment variables (for development)
    - Kubernetes Secrets
    - HashiCorp Vault
    - AWS KMS / Azure Key Vault / GCP KMS
    - Hardware Security Modules (HSM)

    Never commit cryptographic keys to source code.
  tag:
    - "FIPS-140=Unacceptable"
    - "Crypto=Hardcoded-Key"
    - "CWE=CWE-798"

- ruleID: fips-go-ops-00101
  labels:
    - "konveyor.io/target=go"
  effort: 3
  category: mandatory
  description: "Unacceptable: Hardcoded IV/Nonce detected"
  when:
    or:
      - builtin.filecontent:
          pattern: 'cipher\.NewCBCEncrypter\s*\([^,]+,\s*\[\]byte\s*\(\s*"[^"]+"\s*\)\s*\)'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'cipher\.NewCBCDecrypter\s*\([^,]+,\s*\[\]byte\s*\(\s*"[^"]+"\s*\)\s*\)'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'cipher\.NewCFBEncrypter\s*\([^,]+,\s*\[\]byte\s*\(\s*"[^"]+"\s*\)\s*\)'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'cipher\.NewOFB\s*\([^,]+,\s*\[\]byte\s*\(\s*"[^"]+"\s*\)\s*\)'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'cipher\.NewCTR\s*\([^,]+,\s*\[\]byte\s*\(\s*"[^"]+"\s*\)\s*\)'
          filePattern: "*.go"
  message: |
    Critical Security Vulnerability. Hardcoded initialization vector (IV) or nonce detected.

    Static IVs break the security of encryption:
    - Same plaintext produces same ciphertext (CBC)
    - Enables plaintext recovery attacks
    - GCM nonce reuse is catastrophic (key recovery possible)

    Action: Generate IVs/nonces using crypto/rand:
      iv := make([]byte, aes.BlockSize)
      if _, err := io.ReadFull(rand.Reader, iv); err != nil {
          panic(err)
      }

    For GCM, never reuse a nonce with the same key.
  tag:
    - "FIPS-140=Unacceptable"
    - "Crypto=Static-IV"
    - "CWE=CWE-329"

- ruleID: fips-go-ops-00200
  labels:
    - "konveyor.io/target=go"
  effort: 3
  category: mandatory
  description: "Unacceptable: math/rand used for cryptographic purposes"
  when:
    or:
      - builtin.filecontent:
          pattern: '"math/rand"'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'rand\.Seed\s*\('
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'rand\.NewSource\s*\('
          filePattern: "*.go"
  message: |
    Potential Security Issue. math/rand is not cryptographically secure.

    math/rand uses a predictable PRNG:
    - Output can be predicted if seed is known
    - Default seed is deterministic (time-based before Go 1.20)
    - MUST NOT be used for cryptographic purposes

    math/rand is UNACCEPTABLE for:
    - Key generation
    - IV/Nonce generation
    - Token generation
    - Salt generation
    - Any security-sensitive randomness

    Action: Use crypto/rand for all security purposes:
      import "crypto/rand"

      key := make([]byte, 32)
      if _, err := rand.Read(key); err != nil {
          panic(err)
      }
  tag:
    - "FIPS-140=Unacceptable"
    - "Crypto=Weak-Random"
    - "CWE=CWE-338"

- ruleID: fips-go-ops-00201
  labels:
    - "konveyor.io/target=go"
  effort: 1
  category: potential
  description: "Acceptable: crypto/rand usage detected - verify proper usage"
  when:
    or:
      - builtin.filecontent:
          pattern: 'rand\.Read\s*\('
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'io\.ReadFull\s*\(\s*rand\.Reader'
          filePattern: "*.go"
  message: |
    Cryptographic Random Usage. crypto/rand is the correct source for
    cryptographic randomness in Go.

    Verify proper usage:
    - Check error return values
    - Ensure sufficient entropy is read
    - Use io.ReadFull for guaranteed byte counts

    Good pattern:
      key := make([]byte, 32)
      if _, err := io.ReadFull(rand.Reader, key); err != nil {
          return err
      }
  tag:
    - "FIPS-140=Acceptable-Evaluate"
    - "Crypto=Random-Usage"
    - "CWE=CWE-330"

- ruleID: fips-go-ops-00300
  labels:
    - "konveyor.io/target=go"
  effort: 2
  category: potential
  description: "Requires Analysis: Static salt detected in password hashing"
  when:
    or:
      - builtin.filecontent:
          pattern: 'pbkdf2\.Key\s*\([^,]+,\s*\[\]byte\s*\(\s*"[^"]+"\s*\)'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'scrypt\.Key\s*\([^,]+,\s*\[\]byte\s*\(\s*"[^"]+"\s*\)'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'argon2\.\w+\s*\([^,]+,\s*\[\]byte\s*\(\s*"[^"]+"\s*\)'
          filePattern: "*.go"
  message: |
    Potential Issue. Static salt detected in password hashing.

    Salts should be:
    - Unique per password
    - Randomly generated (16+ bytes)
    - Stored alongside the hash

    Static salts enable:
    - Rainbow table attacks
    - Parallel cracking of multiple passwords

    Action: Generate unique salts for each password:
      salt := make([]byte, 16)
      if _, err := rand.Read(salt); err != nil {
          return err
      }
      hash := pbkdf2.Key(password, salt, iterations, keyLen, sha256.New)
  tag:
    - "FIPS-140=Requires-Analysis"
    - "Crypto=Static-Salt"
    - "CWE=CWE-760"

- ruleID: fips-go-ops-00400
  labels:
    - "konveyor.io/target=go"
  effort: 2
  category: potential
  description: "Requires Analysis: GCM nonce generation pattern"
  when:
    builtin.filecontent:
      pattern: '\.Seal\s*\('
      filePattern: "*.go"
  message: |
    GCM Nonce Usage. GCM mode requires unique nonces for security.

    Critical Requirements:
    - Nonce MUST be unique for each encryption with same key
    - Nonce reuse with same key = catastrophic key recovery
    - 12-byte nonces are standard for GCM

    Safe patterns:
    1. Random nonces (for limited messages):
       nonce := make([]byte, 12)
       rand.Read(nonce)

    2. Counter-based nonces (for high-volume):
       atomic.AddUint64(&counter, 1)

    3. Derived nonces (for deterministic encryption):
       Use HKDF with unique context

    Action: Review nonce generation to ensure uniqueness.
  tag:
    - "FIPS-140=Requires-Analysis"
    - "Crypto=GCM-Nonce"
    - "CWE=CWE-323"

- ruleID: fips-go-ops-00500
  labels:
    - "konveyor.io/target=go"
  effort: 2
  category: potential
  description: "Requires Analysis: Timing-safe comparison may be needed"
  when:
    or:
      - builtin.filecontent:
          pattern: 'bytes\.Equal\s*\([^)]*hmac'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'bytes\.Equal\s*\([^)]*hash'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'bytes\.Equal\s*\([^)]*sig'
          filePattern: "*.go"
      - builtin.filecontent:
          pattern: 'bytes\.Equal\s*\([^)]*mac'
          filePattern: "*.go"
  message: |
    Potential Timing Attack. Regular comparison may leak information via timing.

    When comparing cryptographic values (MACs, hashes, signatures),
    use constant-time comparison to prevent timing attacks.

    Vulnerable pattern:
      if bytes.Equal(computedMAC, receivedMAC) { ... }

    Secure pattern:
      import "crypto/subtle"
      if subtle.ConstantTimeCompare(computedMAC, receivedMAC) == 1 { ... }

    Action: Use crypto/subtle.ConstantTimeCompare for all cryptographic comparisons.
  links:
    - title: "Go crypto/subtle Documentation"
      url: "https://pkg.go.dev/crypto/subtle"
  tag:
    - "FIPS-140=Requires-Analysis"
    - "Crypto=Timing-Attack"
    - "CWE=CWE-208"
